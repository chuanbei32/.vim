<!-- æ­£æ–‡å¼€å§‹ -->
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body">
            <form class="layui-form toolbar" id="searchs">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <input type="text" placeholder="ç”¨æˆ·å" id="name" class="layui-input">
                    </div>
                    <div class="layui-inline">
                        <a href="javascript:;" class="layui-btn layui-icon layui-icon-search" id="search"></a>
                    </div>
                </div>
            </form>
            <!-- æ•°æ®è¡¨æ ¼ -->
            <table id="indexAdminTable" lay-filter="indexAdminTable"></table>
        </div>
    </div>
</div>

<!-- è¡¨æ ¼æ“ä½œåˆ— -->
<script type="text/html" id="indexAdminTbBar">
    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="pay">å¦å®šå…³é”®è¯è¯¦ç»†åˆ—è¡¨</a>
</script>
<!-- è¡¨æ ¼çŠ¶æ€åˆ— -->

<!-- è¡¨å•å¼¹çª— -->
<!-- è®¾ç½®å¦è¯ -->
<script type="text/html" id="setNoHtml">
    <form id="setNoForm" lay-filter="setNoFormFilter" class="layui-form model-form">
        <div class="layui-collapse">
            <div class="layui-colla-item">
                <h2 class="layui-colla-title">çŸ­è¯­å¦å®šå…³é”®è¯</h2>
                <div class="layui-colla-content layui-show">
                    <textarea name="phrase" placeholder="ä¸€è¡Œä¸€ä¸ª" class="layui-textarea"></textarea>
                </div>
            </div>
            <div class="layui-colla-item">
                <h2 class="layui-colla-title">ç²¾ç¡®å¦å®šå…³é”®è¯</h2>
                <div class="layui-colla-content layui-show">
                    <textarea name="exact" placeholder="ä¸€è¡Œä¸€ä¸ª" class="layui-textarea"></textarea>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label for="name" class="layui-form-label"><span class="x-red"></span></label>
            <button class="layui-btn" lay-filter="noKeywordsSub" lay-submit>ä¿å­˜</button>
            <button class="layui-btn layui-btn-primary" type="button" ew-event="closeDialog">å–æ¶ˆ</button>
        </div>
    </form>
</script>
<!-- jséƒ¨åˆ† -->
<script>
    layui.use(['layer', 'form', 'upload', 'table', 'util', 'admin', 'laydate'], function () {
        var $ = layui.jquery;
        var layer = layui.layer;
        var form = layui.form;
        var table = layui.table;
        var util = layui.util;
        var admin = layui.admin;
        var upload = layui.upload;
        var laydate = layui.laydate;
        var loadingIndex
        var search = layui.router().search;
        let pageRole = search.pageRole
        var roles = window.localStorage.getItem('roles_' + pageRole)
        let hidden = false;
        if (roles == 4) {
            hidden = true;
        }
        console.log("ğŸš€ ~ file: noKeywords.html ~ line 68 ~ hidden", hidden)
        /* æ¸²æŸ“è¡¨æ ¼ */
        var insTb = table.render({
            elem: '#indexAdminTable',
            url: BASEURL + 'admininfo/getNoKeywordsList' + '?uid=' + pageRole,
            page: true,
            request: {
                pageName: 'p'
                , limitName: 'num'
            }
            , where: {
                roles: roles
            }
            , parseData: function (res) { //res å³ä¸ºåŸå§‹è¿”å›çš„æ•°æ®
                return {
                    "code": 0, //è§£ææ¥å£çŠ¶æ€
                    "msg": res.msg, //è§£ææç¤ºæ–‡æœ¬
                    "count": res.data.total, //è§£ææ•°æ®é•¿åº¦
                    "data": res.data.data //è§£ææ•°æ®åˆ—è¡¨
                };
            },
            toolbar: ['<p>',
                '<button lay-event="add" class="layui-btn layui-btn-sm icon-btn" id="setting"><i class="layui-icon">&#xe654;</i>è®¾ç½®å¦å®šå…³é”®è¯</button>&nbsp;',
                // '<button lay-event="upup" id="upup" class="layui-btn layui-btn-sm layui-btn-danger icon-btn"><i class="layui-icon">&#xe654;</i>ä¸Šä¼ æ–‡ä»¶</button>',
                // '<button lay-event="down" class="layui-btn layui-btn-sm ">ä¸‹è½½ä¸‹çº§ç”¨æˆ·æ¶ˆè´¹æŠ¥è¡¨</button>&nbsp;',
                // '<button lay-event="del" class="layui-btn layui-btn-sm layui-btn-danger icon-btn"><i class="layui-icon">&#xe640;</i>åˆ é™¤</button>',
                '</p>'].join(''),
            cellMinWidth: 100,
            cols: [[
                // {type: 'checkbox'},
                { field: 'uid', title: 'ç”¨æˆ· ID', sort: true, width: 100, hide: hidden },
                {
                    field: 'users', title: 'ç”¨æˆ·å', sort: true, templet: function (d) {
                        return d.users.name
                    }, hide: hidden
                },
                { field: 'phrase', title: 'çŸ­å¦æ•°é‡', sort: true },
                { field: 'exact', title: 'ç²¾å¦æ•°é‡', sort: true },
                { title: 'æ“ä½œ', toolbar: '#indexAdminTbBar', align: 'center', width: 150 }
            ]]
        });
        if (roles != 4) {
            $('#setting').hide()
        } else {
            $('#searchs').hide()
        }

        var start = ''
        var end = ''
        var laydate = layui.laydate;

        /* è¡¨æ ¼æœç´¢ */
        form.on('submit(userTbSearch)', function (data) {
            console.log(data)
            insTb.reload({ where: data.field, page: { curr: 1 } });
            return false;
        });

        $('#search').click(function () {
            var name = $('#name').val()
            insTb.reload({ where: { name: name }, page: { curr: 1 } });
            return false;
        })

        /* è¡¨æ ¼å¤´å·¥å…·æ ç‚¹å‡»äº‹ä»¶ */
        table.on('toolbar(indexAdminTable)', function (obj) {
            if (obj.event === 'down') { // æ·»åŠ 
                down(obj);
            } else if (obj.event === 'del') { // åˆ é™¤
                var checkRows = table.checkStatus('userLogTable');
                if (checkRows.data.length === 0) {
                    layer.msg('è¯·é€‰æ‹©è¦åˆ é™¤çš„æ•°æ®', { icon: 2 });
                    return;
                }
                var ids = checkRows.data.map(function (d) {
                    return d.userId;
                });
                doDel({ ids: ids });
            } else if ('add' == obj.event) {

                $.get(BASEURL + 'admininfo/getNoKeywords' + '?uid=' + pageRole, function (res) {
                    if (0 == res.code) {
                        $('textarea[name=phrase]').val(res.data.phrase.join("\n"))
                        $('textarea[name=exact]').val(res.data.exact.join("\n"))
                    }
                }, 'json');
                admin.open({
                    type: 1,
                    title: 'å¦å®šå…³é”®è¯',
                    content: $('#setNoHtml').html(),
                    area: ['800px', '500px'],
                    success: function (layero, dIndex) {
                        form.on('submit(noKeywordsSub)', function (data) {
                            let loadIndex = layer.load(2);
                            data.field.phrase = data.field.phrase.split(/[\s]/);
                            data.field.exact = data.field.exact.split(/[\s]/);
                            $.post(BASEURL + 'admininfo/setNoKeywords' + '?uid=' + pageRole, data.field, function (res) {
                                layer.close(loadIndex);
                                if (0 == res.code) {
                                    layer.msg(res.msg, { icon: 1 });
                                    layer.close(dIndex);
                                    return
                                }
                                layer.msg(res.msg, { icon: 2 });
                            }, 'json');
                            return false
                        })
                    }
                })
            }
        });

        function down(obj) {
            window.open(req('getPayExcel') + '?uid=' + pageRole + '&start_time=' + start + '&end_time=' + end, '_blank')
        }

        // ä¸‹æ‹‰æ¡†
        form.on('select(text)', function () {
            text = $('#text').val()
            insTb.reload({ page: { page: 1 }, where: { text: text, id: ID } });
        });

        /* åˆ é™¤ */
        function doDel(obj) {
            // console.log(obj)
            // return false
            layer.confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­æ•°æ®å—ï¼Ÿ', {
                skin: 'layui-layer-admin',
                shade: .1
            }, function (i) {
                layer.close(i);
                var loadIndex = layer.load(2);
                $.post(req('brief_del'), {
                    id: obj.data.id
                }, function (res) {
                    layer.close(loadIndex);
                    if (res.status != 2) {
                        layer.msg(res.msg, { icon: 1 });
                        insTb.reload();
                    } else {
                        layer.msg(res.msg, { icon: 2 });
                    }
                }, 'json');
            });
        }

        /* è¡¨æ ¼å·¥å…·æ¡ç‚¹å‡»äº‹ä»¶ */
        table.on('tool(indexAdminTable)', function (obj) {
            if (obj.event === 'pay') {
                console.log(obj)
                list(obj.data.uid);
            }
        });

        function list(id) {
            let s = window.localStorage
            s.setItem('userid', id)
            s.setItem('adminid_' + id, roles)
            admin.open({
                type: 2,
                title: 'å¦å®šå…³é”®è¯è¯¦ç»†åˆ—è¡¨',
                area: ['1350px', '800px'],
                url: '/components/goods/noKeywordsView.html',
                success: (layero, index) => {
                    layer.full(index);
                }
            })
        }

    });
</script>