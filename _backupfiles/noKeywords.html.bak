<!-- 正文开始 -->
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body">
            <form class="layui-form toolbar" id="searchs">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <input type="text" placeholder="用户名" id="name" class="layui-input">
                    </div>
                    <div class="layui-inline">
                        <a href="javascript:;" class="layui-btn layui-icon layui-icon-search" id="search"></a>
                    </div>
                </div>
            </form>
            <!-- 数据表格 -->
            <table id="indexAdminTable" lay-filter="indexAdminTable"></table>
        </div>
    </div>
</div>

<!-- 表格操作列 -->
<script type="text/html" id="indexAdminTbBar">
    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="pay">否定关键词详细列表</a>
</script>
<!-- 表格状态列 -->

<!-- 表单弹窗 -->
<!-- 设置否词 -->
<script type="text/html" id="setNoHtml">
    <form id="setNoForm" lay-filter="setNoFormFilter" class="layui-form model-form">
        <div class="layui-collapse">
            <div class="layui-colla-item">
                <h2 class="layui-colla-title">短语否定关键词</h2>
                <div class="layui-colla-content layui-show">
                    <textarea name="phrase" placeholder="一行一个" class="layui-textarea"></textarea>
                </div>
            </div>
            <div class="layui-colla-item">
                <h2 class="layui-colla-title">精确否定关键词</h2>
                <div class="layui-colla-content layui-show">
                    <textarea name="exact" placeholder="一行一个" class="layui-textarea"></textarea>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label for="name" class="layui-form-label"><span class="x-red"></span></label>
            <button class="layui-btn" lay-filter="noKeywordsSub" lay-submit>保存</button>
            <button class="layui-btn layui-btn-primary" type="button" ew-event="closeDialog">取消</button>
        </div>
    </form>
</script>
<!-- js部分 -->
<script>
    layui.use(['layer', 'form', 'upload', 'table', 'util', 'admin', 'laydate'], function () {
        var $ = layui.jquery;
        var layer = layui.layer;
        var form = layui.form;
        var table = layui.table;
        var util = layui.util;
        var admin = layui.admin;
        var upload = layui.upload;
        var laydate = layui.laydate;
        var loadingIndex
        var search = layui.router().search;
        let pageRole = search.pageRole
        var roles = window.localStorage.getItem('roles_' + pageRole)
        let hidden = false;
        if (roles == 4) {
            hidden = true;
        }
        console.log("🚀 ~ file: noKeywords.html ~ line 68 ~ hidden", hidden)
        /* 渲染表格 */
        var insTb = table.render({
            elem: '#indexAdminTable',
            url: BASEURL + 'admininfo/getNoKeywordsList' + '?uid=' + pageRole,
            page: true,
            request: {
                pageName: 'p'
                , limitName: 'num'
            }
            , where: {
                roles: roles
            }
            , parseData: function (res) { //res 即为原始返回的数据
                return {
                    "code": 0, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": res.data.total, //解析数据长度
                    "data": res.data.data //解析数据列表
                };
            },
            toolbar: ['<p>',
                '<button lay-event="add" class="layui-btn layui-btn-sm icon-btn" id="setting"><i class="layui-icon">&#xe654;</i>设置否定关键词</button>&nbsp;',
                // '<button lay-event="upup" id="upup" class="layui-btn layui-btn-sm layui-btn-danger icon-btn"><i class="layui-icon">&#xe654;</i>上传文件</button>',
                // '<button lay-event="down" class="layui-btn layui-btn-sm ">下载下级用户消费报表</button>&nbsp;',
                // '<button lay-event="del" class="layui-btn layui-btn-sm layui-btn-danger icon-btn"><i class="layui-icon">&#xe640;</i>删除</button>',
                '</p>'].join(''),
            cellMinWidth: 100,
            cols: [[
                // {type: 'checkbox'},
                { field: 'uid', title: '用户 ID', sort: true, width: 100, hide: hidden },
                {
                    field: 'users', title: '用户名', sort: true, templet: function (d) {
                        return d.users.name
                    }, hide: hidden
                },
                { field: 'phrase', title: '短否数量', sort: true },
                { field: 'exact', title: '精否数量', sort: true },
                { title: '操作', toolbar: '#indexAdminTbBar', align: 'center', width: 150 }
            ]]
        });
        if (roles != 4) {
            $('#setting').hide()
        } else {
            $('#searchs').hide()
        }

        var start = ''
        var end = ''
        var laydate = layui.laydate;

        /* 表格搜索 */
        form.on('submit(userTbSearch)', function (data) {
            console.log(data)
            insTb.reload({ where: data.field, page: { curr: 1 } });
            return false;
        });

        $('#search').click(function () {
            var name = $('#name').val()
            insTb.reload({ where: { name: name }, page: { curr: 1 } });
            return false;
        })

        /* 表格头工具栏点击事件 */
        table.on('toolbar(indexAdminTable)', function (obj) {
            if (obj.event === 'down') { // 添加
                down(obj);
            } else if (obj.event === 'del') { // 删除
                var checkRows = table.checkStatus('userLogTable');
                if (checkRows.data.length === 0) {
                    layer.msg('请选择要删除的数据', { icon: 2 });
                    return;
                }
                var ids = checkRows.data.map(function (d) {
                    return d.userId;
                });
                doDel({ ids: ids });
            } else if ('add' == obj.event) {

                $.get(BASEURL + 'admininfo/getNoKeywords' + '?uid=' + pageRole, function (res) {
                    if (0 == res.code) {
                        $('textarea[name=phrase]').val(res.data.phrase.join("\n"))
                        $('textarea[name=exact]').val(res.data.exact.join("\n"))
                    }
                }, 'json');
                admin.open({
                    type: 1,
                    title: '否定关键词',
                    content: $('#setNoHtml').html(),
                    area: ['800px', '500px'],
                    success: function (layero, dIndex) {
                        form.on('submit(noKeywordsSub)', function (data) {
                            let loadIndex = layer.load(2);
                            data.field.phrase = data.field.phrase.split(/[\s]/);
                            data.field.exact = data.field.exact.split(/[\s]/);
                            $.post(BASEURL + 'admininfo/setNoKeywords' + '?uid=' + pageRole, data.field, function (res) {
                                layer.close(loadIndex);
                                if (0 == res.code) {
                                    layer.msg(res.msg, { icon: 1 });
                                    layer.close(dIndex);
                                    return
                                }
                                layer.msg(res.msg, { icon: 2 });
                            }, 'json');
                            return false
                        })
                    }
                })
            }
        });

        function down(obj) {
            window.open(req('getPayExcel') + '?uid=' + pageRole + '&start_time=' + start + '&end_time=' + end, '_blank')
        }

        // 下拉框
        form.on('select(text)', function () {
            text = $('#text').val()
            insTb.reload({ page: { page: 1 }, where: { text: text, id: ID } });
        });

        /* 删除 */
        function doDel(obj) {
            // console.log(obj)
            // return false
            layer.confirm('确定要删除选中数据吗？', {
                skin: 'layui-layer-admin',
                shade: .1
            }, function (i) {
                layer.close(i);
                var loadIndex = layer.load(2);
                $.post(req('brief_del'), {
                    id: obj.data.id
                }, function (res) {
                    layer.close(loadIndex);
                    if (res.status != 2) {
                        layer.msg(res.msg, { icon: 1 });
                        insTb.reload();
                    } else {
                        layer.msg(res.msg, { icon: 2 });
                    }
                }, 'json');
            });
        }

        /* 表格工具条点击事件 */
        table.on('tool(indexAdminTable)', function (obj) {
            if (obj.event === 'pay') {
                console.log(obj)
                list(obj.data.uid);
            }
        });

        function list(id) {
            let s = window.localStorage
            s.setItem('userid', id)
            s.setItem('adminid_' + id, roles)
            admin.open({
                type: 2,
                title: '否定关键词详细列表',
                area: ['1350px', '800px'],
                url: '/components/goods/noKeywordsView.html',
                success: (layero, index) => {
                    layer.full(index);
                }
            })
        }

    });
</script>