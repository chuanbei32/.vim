<!-- 正文开始 -->
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body">
            <form class="layui-form toolbar">
                <br>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <input type="text" class="layui-input" id="start1" placeholder="请选择开始时间">
                    </div>
                    <div class="layui-inline">
                        <input type="text" class="layui-input" id="start2" placeholder="请选择结束时间">
                    </div>
                    <div class="layui-inline">
                        <a href="javascript:;" class="layui-btn layui-icon layui-icon-search" id="searcsh"></a>
                    </div>

                </div>
            </form>
            <!-- 数据表格 -->
            <table id="indexPayTable" lay-filter="indexPayTable"></table>
        </div>
    </div>
</div>

<!-- 表格操作列 -->
<script type="text/html" id="indexTbBar">
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<!-- 表格状态列 -->

<!-- 表单弹窗 -->


<!-- js部分 -->
<script>
    layui.use(['layer', 'form', 'upload', 'table', 'util', 'admin', 'xmSelect', 'laydate'], function () {
        var $ = layui.jquery;
        var layer = layui.layer;
        var form = layui.form;
        var table = layui.table;
        var util = layui.util;
        var admin = layui.admin;
        var xmSelect = layui.xmSelect;
        var upload = layui.upload;
        var loadingIndex
        var s = window.localStorage
        var start_time = '';
        var end_time = '';
        var pageRole = s.getItem('userid');
        var roles = window.localStorage.getItem('adminid_' + pageRole)
        var ins2Tb;

        //  为了区分管理员客服与代理商编辑的权限, false不可编辑
        var edit = 'false';
        var hiide = true;
        var toolbar = [];
        if (roles == 6 || roles == 1) {
            edit = 'text';
            hiide = false
            toolbar = ['<p>',
                // '<button lay-event="delAll" class="layui-btn layui-btn-danger layui-btn-sm icon-btn"><i class="layui-icon">&#xe654;</i>批量删除</button>&nbsp;',
                '<button lay-event="planAll" class="layui-btn layui-btn-normal layui-btn-sm icon-btn"><i class="layui-icon">&#xe654;</i>一键补量</button>&nbsp;',
                '<button lay-event="del" class="layui-btn layui-btn-sm layui-btn-danger icon-btn"><i class="layui-icon">&#xe640;</i>一键删除</button>',
                '</p>'];

        }
        /* 渲染表格 */
        var ins2Tb = table.render({
            elem: '#indexPayTable',
            url: req('supers') + '?uid=' + pageRole,
            page: true,
            request: {
                pageName: 'p'
                , limitName: 'num'
            }
            , where: {
                text: 1
            }
            , parseData: function (res) { //res 即为原始返回的数据
                return {
                    "code": 0, //解析接口状态
                    "msg": res.data, //解析提示文本
                    "count": res.count, //解析数据长度
                    "data": res.data //解析数据列表
                };
            },
            toolbar: toolbar.join(''),
            cellMinWidth: 100,
            cols: [[
                { type: 'checkbox', hide: hiide },
                { field: 'id', title: 'id', sort: true, align: 'center', width: '5%' },
                // {field: 'status', title: '类型', sort: true},
                { field: 'name', title: '消费用户', sort: true, align: 'center', width: '10%' },
                { field: 'antistop', title: '关键词', sort: true, align: 'center', width: '10%', edit: edit },
                { field: 'goods_id', title: '商品 ID', sort: true, align: 'center', width: '10%' },
                { field: 'goods_title', title: '商品关键词', sort: true, align: 'center', width: '10%' },
                { field: 'money', title: '金额', sort: true, align: 'center', width: '10%', edit: edit },
                { field: 'pv', title: '展现', sort: true, width: '10%', edit: edit },
                { field: 'clicks', title: '点击', sort: true, width: '10%', edit: edit },
                { field: 'click_ratio', title: '点击率(%)', sort: true, width: '10%' },
                { field: 'ip', title: 'IP', sort: true, width: '12%', edit: edit },
                { field: 'area', title: '省', sort: true, align: 'center', width: '10%', edit: edit },
                { field: 'city', title: '市', sort: true, align: 'center', width: '10%', edit: edit },
                { field: 'operation', title: '运营商', sort: true, align: 'center', width: '20%', edit: edit },
                // {field: 'consumer', title: '客户端', sort: true, align:'center',width:'10%',edit:edit},
                { field: 'add_time', title: '超量时间', sort: true, width: '15%', edit: edit },
                { title: '操作', toolbar: '#indexTbBar', align: 'center', minWidth: 250, hide: hiide }
            ]]
        });

        // 表格单元框编辑
        table.on('edit(indexPayTable)', function (obj) {
            var value = obj.value //得到修改后的值
                , data = obj.data //得到所在行所有键值
                , field = obj.field; //得到字段
            var idf = data.id;

            // pageRole 用户id
            // id
            // field
            // fieldname
            // uid
            // data
            var fieldName = '';
            switch (field) {
                case 'money':
                    fieldName = '金额';
                    break;
                case 'ip':
                    fieldName = 'IP';
                    break;
                case 'area':
                    fieldName = '省';
                    break;
                case 'city':
                    fieldName = '市';
                    break;
                case 'operator':
                    fieldName = '运营商';
                    break;
                case 'antistop':
                    fieldName = '关键词';
                    break;
                case 'consumer':
                    fieldName = '客户端';
                    break;
                case 'add_time':
                    fieldName: '时间';
                    break;
            }

            $.post(req('editFinanceOther'), {
                fieldName: fieldName,
                field: field,
                data: value,
                id: data.id,
                uid: pageRole
            }, function (r) {

            }, 'json')



            layer.msg('[ID: ' + data.id + '] ' + fieldName + ' 更改为：' + value);
        });


        $('#searcsh').click(function () {
            ins2Tb.reload({ where: { start_time: start_time, end_time: end_time }, page: { curr: 1 } });
            return false;
        })

        var laydate = layui.laydate;

        //执行一个laydate实例
        laydate.render({
            elem: '#start1', //指定元素
            done: function (value, date, endDate) {
                start_time = value
            }
        });
        laydate.render({
            elem: '#start2', //指定元素
            done: function (value, date, endDate) {
                end_time = value
            }
        });



        /* 表格搜索 */
        form.on('submit(userTbSearch)', function (data) {
            insTb.reload({ where: data.field, page: { curr: 1 } });
            return false;
        });


        // 下拉框
        form.on('select(text)', () => {
            text = $('#text').val()
            insTb.reload({ page: { page: 1 }, where: { text: text, id: ID } });
        })

        /* 表格工具条点击事件 */
        table.on('tool(indexPayTable)', function (obj) {
            if (obj.event === 'del') {
                doDel([obj.data.id])
            }
        });

        /*表格头部按钮*/
        table.on('toolbar(indexPayTable)', function (obj) {
            var checkRows = table.checkStatus('indexPayTable');
            if (checkRows.data.length === 0) {
                layer.msg('请选择要操作的数据', { icon: 2 });
                return;
            }
            var ids = checkRows.data.map(function (d) {
                return d.id;
            });
            if (obj.event == 'planAll') {
                planAll(ids)
            }
            if (obj.event == 'del') {
                doDel(ids)
            }
        })

        function planAll(ids) {
            layer.confirm('确定要进行补量操作吗?', function () {
                var loadIndex = layer.load(2);
                $.post(req('apiPlan'), {
                    id: ids
                }, function (res) {
                    layer.close(loadIndex);
                    ins2Tb.reload();
                    if (res.status != 2) {
                        layer.msg(res.msg, { icon: 1 });
                        ins2Tb.reload();
                    } else {
                        layer.msg(res.msg, { icon: 2 });
                    }
                }, 'json');
            })
        }

        /* 删除 */
        function doDel(ids) {
            layer.confirm('确定要删除选中数据吗？', {
                skin: 'layui-layer-admin',
                shade: .1
            }, function (i) {
                layer.close(i);
                var loadIndex = layer.load(2);
                $.post(BASEURL + 'consumption/supersDel', {
                    ids: ids
                }, function (res) {
                    layer.close(loadIndex);
                    ins2Tb.reload();
                    if (res.status != 2) {
                        layer.msg(res.msg, { icon: 1 });
                        ins2Tb.reload();
                    } else {
                        layer.msg(res.msg, { icon: 2 });
                    }
                }, 'json');
            });
        }

    });
</script>