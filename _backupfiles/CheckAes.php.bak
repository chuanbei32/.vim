<?php

namespace app\http\middleware;

use think\Request;
use think\facade\Env;
use app\api\services\Aes;
use app\common\exceptions\ApiException;

class CheckAes
{
    private const NOTS = [
        'alinotify',
        'uploadoneormoreimg'
    ];

    public function handle(Request $request, \Closure $next)
    {
        return $next($request);
        if (Env::get('APP_ENV') == 'prod' && !in_array($request->action(), self::NOTS)) {
            $encrypt = $request->getInput();
            //halt($encrypt);
            // $encrypt = file_get_contents('php://input');
            // $encrypt = 'xmxDDQ/2hp+lpvIv/tPtsAUzPyETSQLQGuZ48ZP0Fdjb+X/y2+qETnhd96zivhYNpIMvU1BjGdrJxqken0fO5HE1AnFvmSOKxmp97ovRfLyPNUjRlJVgojzYfe6iT3/PXCIvUd6M22DxbvezorE/3K+wr/SAm63VdZKzMPAQgTXKoQ6unXdiGZtKuah7lCiq';
            if (empty($encrypt)) {
                throw new ApiException(['message' => '没有权限访问']);
            }
            $timestamp = $request->header('x-mflix-ts', 0);
            $deviceId = $request->header('x-mflix-deviceId', '');
            if (empty($timestamp) || empty($deviceId)) {
                throw new ApiException(['message' => '没有权限访问']);
            }
            // $decrypt = (new Aes($timestamp, $platform))->encrypt(json_encode(['test' => 1]));
            $decrypt = (new Aes($timestamp, $deviceId))->decrypt($encrypt);
            if (false == $decrypt) {
                throw new ApiException(['message' => '没有权限访问']);
            }
            $redis = new \Redis();
            $redis->connect(Env::get('REDIS_HOST'), Env::get('REDIS_PORT'));
            $redis->auth(Env::get('REDIS_PASSWD'));
            $redis->select(1);
            if ($redis->sismember('restrain', $encrypt)) {
                throw new ApiException(['message' => '访问已过期']);
            }
            $redis->set('restrain', $encrypt);
            $requestData = json_decode($decrypt, true);
            if (empty($requestData)) {
                throw new ApiException(['message' => '数据格式不正确']);
            }
            // $requestData = json_decode('{"deviceId":"4A392BEC-2B68-4E94-A456-DAA4F7C6ACC9","ts":"1628069418143","platform":"iOS","version":"2.0.0","checksum":"6378586bb19cbf19fd6743296b579d68","movie_id":4702,"timeline":1686,"total_time":6711}', true);
            if ($request->isPost()) {
                $request->withPost($requestData);
            } else {
                $request->withGet($requestData);
            }
            foreach ($requestData as $key => $value) {
                $request->$key = $value;
            }
        }
        return $next($request);
    }
}
